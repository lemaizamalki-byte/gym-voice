<script>
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

const status = document.getElementById("status");
const mic = document.getElementById("mic");
const summary = document.getElementById("summary");

if (!SpeechRecognition) {
  status.textContent = "‚ùå Safari no soporta reconocimiento de voz";
  throw new Error("No Speech API");
}

const recognition = new SpeechRecognition();
recognition.lang = "es-ES";
recognition.continuous = false;
recognition.interimResults = false;
recognition.maxAlternatives = 1;

let listening = false;
let log = JSON.parse(localStorage.getItem("trainLog")) || [];

// üîí Evitar selecci√≥n y men√∫ t√°ctil
mic.style.userSelect = "none";
mic.style.webkitUserSelect = "none";
mic.style.webkitTouchCallout = "none";

mic.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  if (listening) return;

  try {
    recognition.start();
    listening = true;
    mic.classList.add("recording");
    status.textContent = "üéôÔ∏è Escuchando...";
  } catch (err) {
    status.textContent = "‚ùå No se pudo iniciar el micr√≥fono";
  }
});

mic.addEventListener("pointerup", (e) => {
  e.preventDefault();
  if (!listening) return;

  recognition.stop();
  listening = false;
  mic.classList.remove("recording");
});

recognition.onresult = (e) => {
  const text = e.results[0][0].transcript.toLowerCase();

  const entry = parseTraining(text);
  log.push(entry);
  localStorage.setItem("trainLog", JSON.stringify(log));

  status.textContent = "‚úÖ Guardado";
  updateSummary();
};

recognition.onerror = (e) => {
  status.textContent = "‚ùå Error con el micr√≥fono";
  listening = false;
  mic.classList.remove("recording");
};

function parseTraining(text) {
  const weight = text.match(/(\d+)\s?(kg|kilos?)/);
  const reps = text.match(/(\d+)\s?(reps?|repeticiones?)/);

  return {
    date: new Date().toISOString(),
    exercise: text,
    weight: weight ? parseInt(weight[1]) : null,
    reps: reps ? parseInt(reps[1]) : null
  };
}

function updateSummary() {
  if (log.length === 0) {
    summary.textContent = "A√∫n no hay suficientes datos.";
    return;
  }

  const last = log[log.length - 1];
  summary.textContent =
    `üìä √öltimo:\n${last.exercise}\n` +
    `${last.weight || "?"} kg ¬∑ ${last.reps || "?"} reps`;
}

updateSummary();
</script>

