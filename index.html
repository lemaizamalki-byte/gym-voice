<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gym Voice</title>

<style>
* { user-select: none; -webkit-user-select: none; }

body {
  margin: 0;
  height: 100vh;
  background: #0b132b;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-family: system-ui;
  color: white;
}

#mic {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  background: #22c55e;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 64px;
}

#mic.recording { background: #ef4444; }

#status {
  margin-top: 18px;
  font-size: 16px;
  opacity: .9;
}

#notes {
  position: fixed;
  bottom: 0;
  width: 100%;
  max-height: 35%;
  overflow-y: auto;
  background: rgba(0,0,0,.4);
  padding: 10px;
}

.note {
  font-size: 14px;
  margin-bottom: 6px;
}
</style>
</head>

<body>

<div id="mic">üèãÔ∏è</div>
<div id="status">Mant√©n pulsado para hablar</div>
<div id="notes"></div>

<script>
const mic = document.getElementById("mic");
const status = document.getElementById("status");
const notesBox = document.getElementById("notes");

let recognition = null;
let recording = false;
let safetyTimer = null;
let startTime = 0;

let log = JSON.parse(localStorage.getItem("gymLog")) || [];

function getWeek(date) {
  const d = new Date(date);
  d.setDate(d.getDate() + 4 - (d.getDay() || 7));
  const yearStart = new Date(d.getFullYear(), 0, 1);
  return d.getFullYear() + "-W" +
    Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function renderNotes() {
  notesBox.innerHTML = log
    .slice(-10)
    .reverse()
    .map(n => `<div class="note">üóì ${n.week} ¬∑ ${n.text}</div>`)
    .join("");
}
renderNotes();

function stopAll() {
  if (recognition) {
    try { recognition.abort(); } catch {}
    recognition = null;
  }
  clearTimeout(safetyTimer);
  recording = false;
  mic.classList.remove("recording");
}

mic.addEventListener("touchstart", () => {
  if (recording) return;

  if (!window.webkitSpeechRecognition) {
    status.textContent = "‚ùå Safari no soporta voz";
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "es-ES";
  recognition.continuous = false;
  recognition.interimResults = false;

  recording = true;
  startTime = Date.now();
  mic.classList.add("recording");
  status.textContent = "üéôÔ∏è Escuchando‚Ä¶";

  recognition.start();

  // ‚è±Ô∏è CORTE DE SEGURIDAD (CLAVE)
  safetyTimer = setTimeout(() => {
    stopAll();
    status.textContent = "‚ö†Ô∏è Tiempo agotado";
  }, 7000);

  recognition.onresult = (e) => {
    stopAll();

    const text = e.results?.[0]?.[0]?.transcript;
    if (!text) {
      status.textContent = "‚ùå No se detect√≥ voz";
      return;
    }

    const date = new Date().toISOString();
    const duration = Math.round((Date.now() - startTime) / 1000);

    log.push({
      id: Date.now(),
      date,
      week: getWeek(date),
      duration,
      text
    });

    localStorage.setItem("gymLog", JSON.stringify(log));
    renderNotes();

    status.textContent = "‚úÖ Grabaci√≥n guardada";
  };

  recognition.onerror = () => {
    stopAll();
    status.textContent = "‚ùå Error de micr√≥fono";
  };
});

mic.addEventListener("touchend", () => {
  if (!recording) return;
  stopAll();
  status.textContent = "‚è≥ Procesando‚Ä¶";
});
</script>

</body>
</html>
